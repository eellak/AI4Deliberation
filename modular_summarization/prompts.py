"""Prompt templates & retry-handling utilities.
Focuses on Stage 1–3 without 2.4–2.6 re-join logic.
"""
from __future__ import annotations

from dataclasses import dataclass
from typing import Dict

# ---------------------------------------------------------------------------
# RAW PROMPT TEMPLATES (GREEK)
# ---------------------------------------------------------------------------
STAGE1_PROMPT = (
    "Παρακαλώ δημιουργήστε μια σύντομη περίληψη του παρακάτω κειμένου στα Ελληνικά, σε απλή γλώσσα, "
    "κατάλληλη για πολίτες χωρίς εξειδικευμένες νομικές γνώσεις. Η περίληψη πρέπει να είναι έως {target_sentences} προτάσεις "
    "και περίπου {target_words} λέξεις (όριο {token_limit} tokens).\n"
    "Προσοχή να μη παραλειφθούν αλλαγές σε νόμους, θεσμούς, ή διαδικασίες αν πρόκειται για νομοθετικό άρθρο.\n"
    "Οι περιλήψεις πρέπει να είναι όσο πιο σύντομες γίνεται, διατηρώντας την ουσία του κειμένου και να μην υπερβαίνουν τις {target_sentences} προτάσεις.\n"
    "Σκοπός είναι η κατανόηση του περιεχομένου σε μια πλατφόρμα ηλεκτρονικής διαβούλευσης – μην προσθέτετε εισαγωγική φράση, απλώς γράψτε την περίληψη:"
)

STAGE2_COHESIVE_PROMPT = (
    "Οι παρακάτω είναι ατομικές περιλήψεις πολλαπλών άρθρων από μία ενιαία διαβούλευση. "
    "Παρακαλώ συνδυάστε τις σε ένα ενιαίο, συνεκτικό και περιεκτικό κείμενο στα Ελληνικά που να αποτυπώνει τα κύρια σημεία και τον ευρύτερο στόχο του νομοσχεδίου.\n"
    "Χρησιμοποιήστε απλή, μη τεχνική γλώσσα ώστε να γίνεται κατανοητό από το γενικό κοινό.\n"
    "Στοχεύστε σε περίπου 350–400 λέξεις συνολικά οργανωμένες σε 6–7 μικρές παραγράφους."
)

STAGE2_THEMES_PROMPT = (
    "Αξιοποιώντας τις περιλήψεις των άρθρων που ακολουθούν, καταγράψτε τα κύρια θέματα (π.χ. φορολογία, εργασιακά, προστασία δεδομένων) που επηρεάζουν τους πολίτες.\n"
    "Παρουσιάστε τα σε μορφή λίστας κουκίδων. Για κάθε θέμα δώστε μία σύντομη πρόταση που εξηγεί τον τρόπο με τον οποίο επηρεάζονται οι πολίτες.\n"
    "Χρησιμοποιήστε σαφή και απλή διατύπωση χωρίς νομική ορολογία."
)

STAGE2_PLAN_PROMPT = (
    "Με βάση τις παραπάνω περιλήψεις, σκιαγραφήστε ένα ΣΧΕΔΙΟ ΑΦΗΓΗΣΗΣ με 6–7 ενότητες.\n"
    "Κάθε ενότητα πρέπει να έχει: (α) έναν σύντομο περιγραφικό ΤΙΤΛΟ και (β) 1–2 προτάσεις περιγραφής.\n"
    "Ακολουθήστε δομή Αρχή – Μέση – Τέλος ώστε να διευκολύνεται η κατανόηση της συνολικής ιστορίας του νομοσχεδίου από τον αναγνώστη."
)

STAGE3_EXPOSITION_PROMPT = (
    "Χρησιμοποιώντας (1) τη Συνολική Περίληψη, (2) τα Κύρια Θέματα και (3) το Σχέδιο Αφήγησης, συνθέστε ένα ουδέτερο και ενημερωτικό κείμενο στα Ελληνικά.\n"
    "Το κείμενο θα αποτελέσει ενημερωτικό άρθρο για πολίτες χωρίς νομικές γνώσεις, οπότε απαιτείται απλή γλώσσα και σαφής ροή.\n"
    "Μήκος στόχος: ~600 λέξεις, κατανεμημένες σε λογικές παραγράφους που ακολουθούν το σχέδιο αφήγησης.\n"
    "Αποφύγετε jargon και προσωπικά σχόλια· διατηρήστε ουδέτερο τόνο."
)

CONCISE_CONTINUATION_PROMPT = (
    "Η απάντησή σας διακόπηκε. Ολοκληρώστε άμεσα την τελευταία πρόταση με ελάχιστες λέξεις:"
)

SHORTENING_CORRECTION_PROMPT = (
    "Η περίληψη είναι υπερβολικά μεγάλη ή ατελής. Δημιουργήστε μια νέα, συντομότερη περίληψη, επικεντρωμένη στα κυριότερα σημεία:"
)

# ---------------------------------------------------------------------------
# Stage-2 / Stage-3 hierarchical summary prompts (new)
# ---------------------------------------------------------------------------
STAGE2_CHAPTER_PROMPT = (
    "[SCHEMA:CHAPTER_SUM] \n"
    "Οι παρακάτω λίστα περιέχει σύντομες περιλήψεις άρθρων του ίδιου ΚΕΦΑΛΑΙΟΥ. Κάθε άρθρο είτε τροποποιεί/καταργεί υπάρχουσες διατάξεις είτε εισάγει νέες. "
    "Συνδύασέ τες σε μία συνεκτική περίληψη στα Ελληνικά, με απλή γλώσσα (ιδανικά με μήκος ~{target_words} λέξεις), εστιάζοντας ξεκάθαρα στο ΤΙ αλλάζει ή εισάγει το νομοσχέδιο και πώς επηρεάζει τους πολίτες. "

    "Επέστρεψε **ΜΟΝΟ** έγκυρο JSON με το ακόλουθο σχήμα και καμία επιπλέον λέξη:\n"
    "{{\n  \"summary\": \"...\"\n}}"
)

STAGE3_PART_PROMPT = (
    "[SCHEMA:PART_SUM] \n"
    "Οι παρακάτω σύντομες περιλήψεις αντιστοιχούν στα ΚΕΦΑΛΑΙΑ ενός ΜΕΡΟΥΣ του νομοσχεδίου προς ψήφιση. "
    "Συμπύκνωσέ τες σε μία πλήρη περίληψη (ιδανικά με μήκος ~{target_words} λέξεις) "
    "που περιγράφει τον συνολικό σκοπό του Μέρους, σε απλή γλώσσα.\n"
    "Μην αναφαίρεσε σε συγκεκριμένα άρθρα ή παραγράφους των νόμων που μπορεί να αλλάζουν.\n"
    "Η περίληψη σου αυτή ειναι για ένας Μέρος του νομοσχεδίου όχι για όλο το νομοσχέδιο.\n"
    "Μην αναφαίρεσε σε όλο το νομοσχέδιο εκτός και αν χρειάζεται ειδική αναφορά μέσα στο κείμενο.\n"
    "Δημιούργησε μια αφηγηματική περίληψη των αλλαγών που εφαρμόζει ο νόμος από το πρώτο κεφάλαιο μέχρι το τελευταίο\n"
    "ώστε ένας απλός πολίτης να μπορεί να καταλάβει που στοχεύει ο νόμος και τι αλλαγές επιφέρει.\n"
    "Ξεκίνα την απάντηση σου με 'Ο σκοπός του μέρους είναι'.\n"
    "Επέστρεψε **ΜΟΝΟ** το εξής JSON χωρίς καμία άλλη λέξη:\n"
    "{{\n  \"summary\": \"...\"\n}}"
)


STAGE3_PART_SKOPOS_PREFIX = (
    "Ο σκοπός του Μέρους όπως περιγράφεται από το υπουργείο είναι: "
)

STAGE3_PART_ANTIKEIMENO_PREFIX = (
    "Το αντικείμενο του Μέρους όπως περιγράφεται από το υπουργείο είναι: "
)

# ---------------------------------------------------------------------------
# Stage-3 Expansion: Two-stage narrative summarization prompts
# ---------------------------------------------------------------------------

STAGE3_PLAN_PROMPT_A = """[SCHEMA:NARRATIVE_PLAN]\n**Ρόλος (Persona):**
Είστε ένας διακεκριμένος δημοσιογράφος, με πολυετή εμπειρία στην κάλυψη νομοθετικού έργου για μεγάλα ειδησεογραφικά μέσα. Το πάθος σας είναι η προάσπιση της δημοκρατίας μέσω της έγκυρης ενημέρωσης. Στόχος σας είναι να "μεταφράζετε" πολύπλοκες νομοθετικές αλλαγές σε απλή, κατανοητή και συνεκτική γλώσσα για το ευρύ κοινό.

**Οδηγίες:**
Σας παρέχονται τα επίσημα κείμενα «Σκοπός» ή/και «Αντικείμενο» για ένα Μέρος της νομοθεσίας, καθώς και οι περιλήψεις των κεφαλαίων που το απαρτίζουν. Δημιουργήστε ένα δομημένο αφηγηματικό σχέδιο σε μορφή JSON.

Επιστρέφετε **μόνο** έγκυρο JSON, κανέναν άλλον χαρακτήρα πριν ή μετά:

{
  "overall_narrative_arc": "Μία πρόταση που συνοψίζει το συνολικό αφηγηματικό τόξο του Μέρους",
  "protagonist": "Ο κύριος φορέας/θεσμός/έννοια που επηρεάζεται (π.χ. πολίτες, ΑΑΔΕ, επιχειρήσεις)",
  "problem": "Το πρόβλημα που επιχειρεί να λύσει αυτό το Μέρος του νόμου",
  "narrative_sections": [
    {
      "section_title": "Περιεκτικός τίτλος",
      "section_role": "Περιγραφή του σκοπού αυτής της ενότητας στη συνολική αφήγηση",
      "source_chapters": [0, 1]
    }
  ]
}

ΟΔΗΓΙΕΣ:
- overall_narrative_arc: Μία συνοπτική πρόταση για τη συνολική ιστορία
- protagonist: Ποιος επηρεάζεται κυρίως από τις αλλαγές
- problem: Τι πρόβλημα λύνει αυτό το νομοθετικό Μέρος
- narrative_sections: Λίστα 3-6 θεματικών ενοτήτων, καθεμία με:
  * section_title: Σύντομος περιγραφικός τίτλος (max 10 λέξεις)
  * section_role: Πώς αυτή η ενότητα συμβάλλει στη συνολική αφήγηση
  * source_chapters: Indices των κεφαλαίων που περιλαμβάνει αυτή η ενότητα

ΘΥΜΗΣΟΥ: Επιστρέφεις ΜΟΝΟ έγκυρο JSON."""

STAGE3_PLAN_PROMPT_B = """[SCHEMA:NARRATIVE_PLAN]\n**Ρόλος (Persona):**
Είστε ένας διακεκριμένος δημοσιογράφος, με πολυετή εμπειρία στην κάλυψη νομοθετικού έργου για μεγάλα ειδησεογραφικά μέσα. Το πάθος σας είναι η προάσπιση της δημοκρατίας μέσω της έγκυρης ενημέρωσης. Στόχος σας είναι να "μεταφράζετε" πολύπλοκες νομοθετικές αλλαγές σε απλή, κατανοητή και συνεκτική γλώσσα για το ευρύ κοινό.

**Οδηγίες:**
Σας παρέχονται οι περιλήψεις των κεφαλαίων που απαρτίζουν ένα Μέρος της νομοθεσίας. Δημιουργήστε ένα δομημένο αφηγηματικό σχέδιο σε μορφή JSON βασιζόμενοι μόνο στις περιλήψεις των κεφαλαίων.

Επιστρέφετε **μόνο** έγκυρο JSON, κανέναν άλλον χαρακτήρα πριν ή μετά:

{
  "overall_narrative_arc": "Μία πρόταση που συνοψίζει το συνολικό αφηγηματικό τόξο του Μέρους",
  "protagonist": "Ο κύριος φορέας/θεσμός/έννοια που επηρεάζεται (π.χ. πολίτες, ΑΑΔΕ, επιχειρήσεις)",
  "problem": "Το πρόβλημα που επιχειρεί να λύσει αυτό το Μέρος του νόμου",
  "narrative_sections": [
    {
      "section_title": "Περιεκτικός τίτλος",
      "section_role": "Περιγραφή του σκοπού αυτής της ενότητας στη συνολική αφήγηση",
      "source_chapters": [0, 1]
    }
  ]
}

ΟΔΗΓΙΕΣ:
- overall_narrative_arc: Μία συνοπτική πρόταση για τη συνολική ιστορία
- protagonist: Ποιος επηρεάζεται κυρίως από τις αλλαγές
- problem: Τι πρόβλημα λύνει αυτό το νομοθετικό Μέρος (εξάγετε το από τις περιλήψεις)
- narrative_sections: Λίστα 3-6 θεματικών ενοτήτων, καθεμία με:
  * section_title: Σύντομος περιγραφικός τίτλος (max 10 λέξεις)
  * section_role: Πώς αυτή η ενότητα συμβάλλει στη συνολική αφήγηση
  * source_chapters: Indices των κεφαλαίων που περιλαμβάνει αυτή η ενότητα

ΘΥΜΗΣΟΥ: Επιστρέφεις ΜΟΝΟ έγκυρο JSON."""

STAGE3_SYNTH_PROMPT = """[SCHEMA:NARRATIVE_SECTION]\n**Ρόλος (Persona):**
Είστε ένας διακεκριμένος δημοσιογράφος, με πολυετή εμπειρία στην κάλυψη νομοθετικού έργου για μεγάλα ειδησεογραφικά μέσα. Το πάθος σας είναι η προάσπιση της δημοκρατίας μέσω της έγκυρης ενημέρωσης. Στόχος σας είναι να "μεταφράζετε" πολύπλοκες νομοθετικές αλλαγές σε απλή, κατανοητή και συνεκτική γλώσσα για το ευρύ κοινό.

**Οδηγίες:**
Σας παρέχω ολόκληρο το αφηγηματικό σχέδιο για ένα Μέρος της νομοθεσίας, τις αρχικές περιλήψεις των κεφαλαίων που σχετίζονται με **μία συγκεκριμένη ενότητα**, και τον τίτλο της ενότητας που πρέπει να συγγράψετε.

1. **Κατανοήστε το Πλαίσιο:** Μελετήστε το αφηγηματικό σχέδιο για να αντιληφθείτε πώς η συγκεκριμένη ενότητα εντάσσεται στη συνολική αφήγηση.
2. **Συγγράψτε την Ενότητα:** Δημιουργήστε μία συνεκτική και πληροφοριακή παράγραφο που συνοψίζει το περιεχόμενο των σχετικών κεφαλαίων.
3. **Συμπίεση & Ποιότητα:** Η παράγραφος πρέπει να είναι περιεκτική (~60-80 λέξεις), με απλή γλώσσα, αποφεύγοντας νομικούς όρους όπου είναι δυνατόν.

Επιστρέφετε **μόνο** έγκυρο JSON, κανέναν άλλον χαρακτήρα πριν ή μετά:

{
  "paragraph": "Η παράγραφος που συνοψίζει αυτή την ενότητα του νομοθετικού μέρους..."
}

ΟΔΗΓΙΕΣ:
- paragraph: Περιεκτική παράγραφος 60-80 λέξεων που συνοψίζει την ενότητα
- Χρησιμοποιήστε απλή, κατανοητή γλώσσα
- Ξεκινήστε με εισαγωγική αναφορά στον τίτλο της ενότητας
- Εστιάστε στο πώς επηρεάζει τους πολίτες

ΘΥΜΗΣΟΥ: Επιστρέφεις ΜΟΝΟ έγκυρο JSON."""

LAW_MOD_JSON_PROMPT_W_MDATA = (
    """Το παρακάτω κείμενο τροποποιεί, καταργεί ή συμπληρώνει προϋπάρχουσες
    διατάξεις νόμου. Επιστρέφεις **μόνο** έγκυρο JSON, κανέναν άλλον
    χαρακτήρα πριν ή μετά:

    {
      "law_reference": "<αριθμός_νόμου>/<έτος>",
      "article_number": "<άρθρο ή παράγραφος που αλλάζει>",
      "change_type": "<τροποποιείται|καταργείται|αντικαθίσταται|προστίθεται|συμπληρώνεται|διαγράφεται>",
      "major_change_summary": "<έως 40 λέξεις που εξηγούν ΤΙ αλλάζει και ΓΙΑΤΙ είναι σημαντικό· αγνόησε αναριθμήσεις ή καθαρά παραπομπές>",
      "key_themes": ["<keyword_1>", "<keyword_2>", "<keyword_3>"]
    }

    ΟΔΗΓΙΕΣ ΓΙΑ major_change_summary
    - Περιέγραψε την ουσία και τον στόχο της αλλαγής (πολιτική, δικαιούχοι, διαδικασία).
    - Μην αναφέρεις κωδικούς ΦΕΚ ή αναρίθμηση άρθρων.
    - Πρέπει να είναι 1-2 προτάσεις σε μήκος


    ΟΔΗΓΙΕΣ ΓΙΑ key_themes
    - 1-3 αγγλικές λέξεις η καθεμία, με κάτω παύλα αντί για κενά, χωρίς σημεία στίξης.

    ΠΑΡΑΔΕΙΓΜΑ
    {
      "law_reference": "ν. 1234/2023",
      "article_number": "άρθρο 5",
      "change_type": "τροποποιείται",
      "major_change_summary": "Μετατοπίζει τη στήριξη από αποκλειστικά νεοφυείς επιχειρήσεις σε ευρύτερο καθεστώς ψηφιακού μετασχηματισμού, διευρύνοντας τους δυνητικούς δικαιούχους.",
      "key_themes": ["digital_transformation", "broadening_of_beneficiaries"]
    }

    ΘΥΜΗΣΟΥ: Επιστρέφεις ΜΟΝΟ έγκυρο JSON."""
)

LAW_NEW_JSON_PROMPT = (
    """Το παρακάτω κείμενο εισάγει νέες διατάξεις, ορισμούς ή ρυθμίσεις χωρίς να τροποποιεί προϋπάρχοντες νόμους.
    Επιστρέφεις **μόνο** έγκυρο JSON, κανέναν άλλον χαρακτήρα πριν ή μετά:

    {
      "article_title": "<τίτλος άρθρου>",
      "provision_type": "<ορισμός|αρμοδιότητες|διαδικασία|οργάνωση|ρύθμιση|διάρθρωση|κυρώσεις|οικονομικά>",
      "core_provision_summary": "<έως 40 λέξεις που εξηγούν ΤΙ θεσπίζεται και ΠΟΙΟΝ αφορά>",
      "key_themes": ["<keyword_1>", "<keyword_2>", "<keyword_3>"]
    }

    ΟΔΗΓΙΕΣ ΓΙΑ core_provision_summary
    - Περιέγραψε τι καθιερώνεται/ορίζεται και την πρακτική του σημασία.
    - Εστίασε στην ουσία, όχι σε διαδικαστικές λεπτομέρειες.
    - Πρέπει να είναι 1-2 προτάσεις σε μήκος

    ΟΔΗΓΙΕΣ ΓΙΑ provision_type
    - ορισμός: θεσμική φύση, έννοιες, κατηγορίες
    - αρμοδιότητες: καθήκοντα και εξουσίες φορέων
    - διαδικασία: μέθοδοι και βήματα εφαρμογής
    - οργάνωση: δομές και ιεραρχία
    - ρύθμιση: κανόνες και υποχρεώσεις
    - διάρθρωση: συγκρότηση και σύνθεση οργάνων
    - κυρώσεις: θέσπιση ποινών  ή διοικητικών κυρώσεων
    - οικονομικά: καθορισμός προϋπολογισμών, χρηματοδοτήσεων 


    ΟΔΗΓΙΕΣ ΓΙΑ key_themes
    - 1-3 αγγλικές λέξεις η καθεμία, με κάτω παύλα αντί για κενά, χωρίς σημεία στίξης.

    ΠΑΡΑΔΕΙΓΜΑ
    {
      "article_title": "Επίσημο Λογότυπο Ελληνικής Αστυνομίας",
      "provision_type": "ρύθμιση",
      "core_provision_summary": "Καθιερώνεται επίσημο λογότυπο Ελληνικής Αστυνομίας για ενιαία ταυτότητα και αναγνωρισιμότητα του Σώματος με αποκλειστική χρήση από τις υπηρεσίες της.",
      "key_themes": ["organization_identity", "official_logo"]
    }

    ΘΥΜΗΣΟΥ: Επιστρέφεις ΜΟΝΟ έγκυρο JSON."""
)

# ---------------------------------------------------------------------------
# PUBLIC REGISTRY & FACTORY
# ---------------------------------------------------------------------------
PROMPTS: Dict[str, str] = {
    "stage1_article": STAGE1_PROMPT,
    "stage2_cohesive": STAGE2_COHESIVE_PROMPT,
    "stage2_themes": STAGE2_THEMES_PROMPT,
    "stage2_plan": STAGE2_PLAN_PROMPT,
    "stage3_exposition": STAGE3_EXPOSITION_PROMPT,
    "concise_continuation": CONCISE_CONTINUATION_PROMPT,
    "shortening_correction": SHORTENING_CORRECTION_PROMPT,

    "law_mod_json_mdata": LAW_MOD_JSON_PROMPT_W_MDATA,
    "law_new_json": LAW_NEW_JSON_PROMPT,
    "stage2_chapter": STAGE2_CHAPTER_PROMPT,
    "stage3_part": STAGE3_PART_PROMPT,
    "stage3_part_skopos": STAGE3_PART_SKOPOS_PREFIX,
    "stage3_part_antikeimeno": STAGE3_PART_ANTIKEIMENO_PREFIX,
    
    # Stage 3 Expansion: two-step narrative summarization
    "stage3_plan_a": STAGE3_PLAN_PROMPT_A,  # With Σκοπός/Αντικείμενο
    "stage3_plan_b": STAGE3_PLAN_PROMPT_B,  # Without Σκοπός/Αντικείμενο
    "stage3_synth": STAGE3_SYNTH_PROMPT,    # Chunk synthesis
}

def get_prompt(key: str) -> str:
    """Return prompt text; raises KeyError if not found."""
    return PROMPTS[key]

__all__ = list(PROMPTS.keys()) + [
    "PROMPTS",
    "get_prompt",
]

# NOTE: Retry logic moved to `retry.py` to decouple generation heuristics from templates.
