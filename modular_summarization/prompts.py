"""Prompt templates & retry-handling utilities.
Focuses on Stage 1–3 without 2.4–2.6 re-join logic.
"""
from __future__ import annotations

from dataclasses import dataclass
from typing import Dict

# ---------------------------------------------------------------------------
# RAW PROMPT TEMPLATES (GREEK)
# ---------------------------------------------------------------------------
STAGE1_PROMPT = (
    "Παρακαλώ δημιουργήστε μια σύντομη περίληψη του παρακάτω κειμένου στα Ελληνικά, σε απλή γλώσσα, "
    "κατάλληλη για πολίτες χωρίς εξειδικευμένες νομικές γνώσεις. Η περίληψη πρέπει να είναι έως {target_sentences} προτάσεις "
    "και περίπου {target_words} λέξεις (όριο {token_limit} tokens).\n"
    "Προσοχή να μη παραλειφθούν αλλαγές σε νόμους, θεσμούς, ή διαδικασίες αν πρόκειται για νομοθετικό άρθρο.\n"
    "Οι περιλήψεις πρέπει να είναι όσο πιο σύντομες γίνεται, διατηρώντας την ουσία του κειμένου και να μην υπερβαίνουν τις {target_sentences} προτάσεις.\n"
    "Σκοπός είναι η κατανόηση του περιεχομένου σε μια πλατφόρμα ηλεκτρονικής διαβούλευσης – μην προσθέτετε εισαγωγική φράση, απλώς γράψτε την περίληψη:"
)

STAGE2_COHESIVE_PROMPT = (
    "Οι παρακάτω είναι ατομικές περιλήψεις πολλαπλών άρθρων από μία ενιαία διαβούλευση. "
    "Παρακαλώ συνδυάστε τις σε ένα ενιαίο, συνεκτικό και περιεκτικό κείμενο στα Ελληνικά που να αποτυπώνει τα κύρια σημεία και τον ευρύτερο στόχο του νομοσχεδίου.\n"
    "Χρησιμοποιήστε απλή, μη τεχνική γλώσσα ώστε να γίνεται κατανοητό από το γενικό κοινό.\n"
    "Στοχεύστε σε περίπου 350–400 λέξεις συνολικά οργανωμένες σε 6–7 μικρές παραγράφους."
)

STAGE2_THEMES_PROMPT = (
    "Αξιοποιώντας τις περιλήψεις των άρθρων που ακολουθούν, καταγράψτε τα κύρια θέματα (π.χ. φορολογία, εργασιακά, προστασία δεδομένων) που επηρεάζουν τους πολίτες.\n"
    "Παρουσιάστε τα σε μορφή λίστας κουκίδων. Για κάθε θέμα δώστε μία σύντομη πρόταση που εξηγεί τον τρόπο με τον οποίο επηρεάζονται οι πολίτες.\n"
    "Χρησιμοποιήστε σαφή και απλή διατύπωση χωρίς νομική ορολογία."
)

STAGE2_PLAN_PROMPT = (
    "Με βάση τις παραπάνω περιλήψεις, σκιαγραφήστε ένα ΣΧΕΔΙΟ ΑΦΗΓΗΣΗΣ με 6–7 ενότητες.\n"
    "Κάθε ενότητα πρέπει να έχει: (α) έναν σύντομο περιγραφικό ΤΙΤΛΟ και (β) 1–2 προτάσεις περιγραφής.\n"
    "Ακολουθήστε δομή Αρχή – Μέση – Τέλος ώστε να διευκολύνεται η κατανόηση της συνολικής ιστορίας του νομοσχεδίου από τον αναγνώστη."
)

STAGE3_EXPOSITION_PROMPT = (
    "Χρησιμοποιώντας (1) τη Συνολική Περίληψη, (2) τα Κύρια Θέματα και (3) το Σχέδιο Αφήγησης, συνθέστε ένα ουδέτερο και ενημερωτικό κείμενο στα Ελληνικά.\n"
    "Το κείμενο θα αποτελέσει ενημερωτικό άρθρο για πολίτες χωρίς νομικές γνώσεις, οπότε απαιτείται απλή γλώσσα και σαφής ροή.\n"
    "Μήκος στόχος: ~600 λέξεις, κατανεμημένες σε λογικές παραγράφους που ακολουθούν το σχέδιο αφήγησης.\n"
    "Αποφύγετε jargon και προσωπικά σχόλια· διατηρήστε ουδέτερο τόνο."
)

CONCISE_CONTINUATION_PROMPT = (
    "Η απάντησή σας διακόπηκε. Ολοκληρώστε άμεσα την τελευταία πρόταση με ελάχιστες λέξεις:"
)

SHORTENING_CORRECTION_PROMPT = (
    "Η περίληψη είναι υπερβολικά μεγάλη ή ατελής. Δημιουργήστε μια νέα, συντομότερη περίληψη, επικεντρωμένη στα κυριότερα σημεία:"
)

LAW_MOD_JSON_PROMPT = (
    "Το παρακάτω κείμενο φαίνεται να ΤΡΟΠΟΠΟΙΕΙ ή ΚΑΤΑΡΓΕΙ προηγούμενες διατάξεις νόμου. "
    "Ανάλυσε το και επέστρεψε **ΜΟΝΟ** έγκυρο JSON, χωρίς πρόσθετο κείμενο, με την εξής δομή:\n"
    "{\n"
    "  \"law_reference\": \"<αριθμός_νόμου>/<έτος>\",\n"
    "  \"article_number\": \"<άρθρο που αλλάζει>\",\n"
    "  \"change_type\": \"<τροποποιείται|καταργείται|αντικαθίσταται|προστίθεται>\",\n"
    "  \"major_change_summary\": \"<σύντομη περιγραφή στα ελληνικά>\"\n"
    "}\n\n"
    "Βεβαιώσου ότι:\n"
    "* το `law_reference` είναι ο αριθμός και το έτος του νόμου που αναφέρεται (π.χ. \"4887/2022\").\n"
    "* το `article_number` είναι το άρθρο ή η παράγραφος που τροποποιείται (όπως εμφανίζεται στο κείμενο).\n"
    "* το `change_type` είναι μία από τις αναφερόμενες λέξεις κλειδιά.\n"
    "* το `major_change_summary` δεν ξεπερνά {target_sentences} προτάσεις / ~{target_words} λέξεις (όριο {token_limit} tokens)."
)

LAW_MOD_JSON_PROMPT_W_MDATA = (
    """Το παρακάτω κείμενο τροποποιεί, καταργεί ή συμπληρώνει προϋπάρχουσες
    διατάξεις νόμου. Επιστρέφεις **μόνο** έγκυρο JSON, κανέναν άλλον
    χαρακτήρα πριν ή μετά:

    {
      "law_reference": "<αριθμός_νόμου>/<έτος>",
      "article_number": "<άρθρο ή παράγραφος που αλλάζει>",
      "change_type": "<τροποποιείται|καταργείται|αντικαθίσταται|προστίθεται|συμπληρώνεται|διαγράφεται>",
      "major_change_summary": "<έως 40 λέξεις που εξηγούν ΤΙ αλλάζει και ΓΙΑΤΙ είναι σημαντικό· αγνόησε αναριθμήσεις ή καθαρά παραπομπές>",
      "key_themes": ["<kw1_snake_case>", "<kw2_snake_case>", "<kw3_snake_case?>"]
    }

    ΟΔΗΓΙΕΣ ΓΙΑ major_change_summary
    - Περιέγραψε την ουσία και τον στόχο της αλλαγής (πολιτική, δικαιούχοι, διαδικασία).
    - Μην αναφέρεις κωδικούς ΦΕΚ ή αναρίθμηση άρθρων.

    ΟΔΗΓΙΕΣ ΓΙΑ key_themes
    - 1-3 λέξεις η καθεμία, snake_case, χωρίς σημεία στίξης.
    - Εστίασε σε θεματικούς άξονες (π.χ. βιώσιμη_ανάπτυξη, ταχεία_αδειοδότηση).

    ΠΑΡΑΔΕΙΓΜΑ
    {
      "law_reference": "ν. 1234/2023",
      "article_number": "άρθρο 5",
      "change_type": "τροποποιείται",
      "major_change_summary": "Μετατοπίζει τη στήριξη από αποκλειστικά νεοφυείς επιχειρήσεις σε ευρύτερο καθεστώς ψηφιακού μετασχηματισμού, διευρύνοντας τους δυνητικούς δικαιούχους.",
      "key_themes": ["ψηφιακός_μετασχηματισμός", "διεύρυνση_δικαιούχων"]
    }

    ΘΥΜΗΣΟΥ: Επιστρέφεις ΜΟΝΟ έγκυρο JSON."""
)

LAW_NEW_JSON_PROMPT = (
    """Το παρακάτω κείμενο εισάγει νέες διατάξεις, ορισμούς ή ρυθμίσεις χωρίς να τροποποιεί προϋπάρχοντες νόμους.
    Επιστρέφεις **μόνο** έγκυρο JSON, κανέναν άλλον χαρακτήρα πριν ή μετά:

    {
      "article_title": "<τίτλος άρθρου>",
      "provision_type": "<ορισμός|σκοπός|αρμοδιότητες|διαδικασία|οργάνωση|ρύθμιση|διάρθρωση>",
      "core_provision_summary": "<έως 40 λέξεις που εξηγούν ΤΙ θεσπίζεται και ΠΟΙΟΝ αφορά>",
      "key_themes": ["<kw1_snake_case>", "<kw2_snake_case>", "<kw3_snake_case?>"]
    }

    ΟΔΗΓΙΕΣ ΓΙΑ core_provision_summary
    - Περιέγραψε τι καθιερώνεται/ορίζεται και την πρακτική του σημασία.
    - Εστίασε στην ουσία, όχι σε διαδικαστικές λεπτομέρειες.

    ΟΔΗΓΙΕΣ ΓΙΑ provision_type
    - ορισμός: θεσμική φύση, έννοιες, κατηγορίες
    - σκοπός: στόχοι νομοθετήματος
    - αρμοδιότητες: καθήκοντα και εξουσίες φορέων
    - διαδικασία: μέθοδοι και βήματα εφαρμογής
    - οργάνωση: δομές και ιεραρχία
    - ρύθμιση: κανόνες και υποχρεώσεις
    - διάρθρωση: συγκρότηση και σύνθεση οργάνων

    ΠΑΡΑΔΕΙΓΜΑ
    {
      "article_title": "Επίσημο Λογότυπο Ελληνικής Αστυνομίας",
      "provision_type": "ρύθμιση",
      "core_provision_summary": "Καθιερώνεται επίσημο λογότυπο Ελληνικής Αστυνομίας για ενιαία ταυτότητα και αναγνωρισιμότητα του Σώματος με αποκλειστική χρήση από τις υπηρεσίες της.",
      "key_themes": ["εταιρική_ταυτότητα", "επίσημα_σύμβολα"]
    }

    ΘΥΜΗΣΟΥ: Επιστρέφεις ΜΟΝΟ έγκυρο JSON."""
)

# ---------------------------------------------------------------------------
# PUBLIC REGISTRY & FACTORY
# ---------------------------------------------------------------------------
PROMPTS: Dict[str, str] = {
    "stage1_article": STAGE1_PROMPT,
    "stage2_cohesive": STAGE2_COHESIVE_PROMPT,
    "stage2_themes": STAGE2_THEMES_PROMPT,
    "stage2_plan": STAGE2_PLAN_PROMPT,
    "stage3_exposition": STAGE3_EXPOSITION_PROMPT,
    "concise_continuation": CONCISE_CONTINUATION_PROMPT,
    "shortening_correction": SHORTENING_CORRECTION_PROMPT,
    "law_mod_json": LAW_MOD_JSON_PROMPT,
    "law_mod_json_mdata": LAW_MOD_JSON_PROMPT_W_MDATA,
    "law_new_json": LAW_NEW_JSON_PROMPT,
}

def get_prompt(key: str) -> str:
    """Return prompt text; raises KeyError if not found."""
    return PROMPTS[key]

__all__ = list(PROMPTS.keys()) + [
    "PROMPTS",
    "get_prompt",
]

# NOTE: Retry logic moved to `retry.py` to decouple generation heuristics from templates.
